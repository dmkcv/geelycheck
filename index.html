<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∫–∞–Ω–µ—Ä –∞–≤—Ç–æ–∑–∞–ø—á–∞—Å—Ç–µ–π –∫–æ–Ω—Ü–µ—Ä–Ω–∞ Geely</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        :root {
            --primary: #0056b3;
            --primary-hover: #004494;
            --bg: #f4f4f9;
            --card: #ffffff;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            width: 100%;
            max-width: 600px;
            background: var(--card);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 20px;
            box-sizing: border-box;
        }
        h1 { margin: 0 0 20px 0; text-align: center; color: #333; font-size: 1.4rem; }

        /* Brand Selector */
        .brand-selector {
            display: flex;
            border: 1px solid var(--primary);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        .brand-option { flex: 1; position: relative; }
        .brand-option input { position: absolute; opacity: 0; width: 0; height: 0; }
        .brand-option label {
            display: block;
            padding: 10px 0;
            text-align: center;
            background: #fff;
            color: var(--primary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border-right: 1px solid var(--primary);
            transition: 0.2s;
        }
        .brand-option:last-child label { border-right: none; }
        .brand-option input:checked + label {
            background: var(--primary);
            color: white;
        }

        /* Scanner Area */
        #reader {
            width: 100%;
            min-height: 300px;
            background: #000;
            border-radius: 12px;
            margin-bottom: 20px;
            display: none; /* –°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            position: relative;
            overflow: hidden;
        }
        #reader video { object-fit: cover; border-radius: 12px; width: 100% !important; height: 100% !important; }

        /* Action Buttons */
        .actions { display: flex; flex-direction: column; gap: 10px; }
        
        .btn {
            border: none;
            padding: 14px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }
        
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: white; border: 2px solid var(--primary); color: var(--primary); }
        .btn-stop { background: #dc3545; color: white; display: none; }

        /* Hidden File Input */
        #fileInput { display: none; }

        /* Results */
        .result-card {
            margin-top: 20px;
            padding: 20px;
            border-radius: 12px;
            display: none;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        .result-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .result-row:last-child { border-bottom: none; }
        .label { font-weight: bold; font-size: 0.9rem; opacity: 0.7; }
        .value { font-weight: 500; text-align: right; }

        .loader {
            display: none;
            text-align: center;
            color: var(--primary);
            margin: 20px 0;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>–°–∫–∞–Ω–µ—Ä –∞–≤—Ç–æ–∑–∞–ø—á–∞—Å—Ç–µ–π –∫–æ–Ω—Ü–µ—Ä–Ω–∞ Geely</h1>

    <!-- –í—ã–±–æ—Ä –±—Ä–µ–Ω–¥–∞ -->
    <div class="brand-selector">
        <div class="brand-option">
            <input type="radio" name="brand" id="brand_geely" value="GEELY" checked>
            <label for="brand_geely">Geely</label>
        </div>
        <div class="brand-option">
            <input type="radio" name="brand" id="brand_zeekr" value="ZEEKR">
            <label for="brand_zeekr">Zeekr</label>
        </div>
        <div class="brand-option">
            <input type="radio" name="brand" id="brand_lynk" value="LYNKCO">
            <label for="brand_lynk">Lynk</label>
        </div>
        <div class="brand-option">
            <input type="radio" name="brand" id="brand_lining" value="LINING">
            <label for="brand_lining">Lining</label>
        </div>
    </div>

    <!-- –û–±–ª–∞—Å—Ç—å –∫–∞–º–µ—Ä—ã -->
    <div id="reader"></div>

    <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div class="actions" id="actionButtons">
        <!-- –ö–Ω–æ–ø–∫–∞ 1: –ñ–∏–≤–∞—è –∫–∞–º–µ—Ä–∞ -->
        <button class="btn btn-primary" onclick="startCamera()" id="btnStart">
            <span>üì∑</span> –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É
        </button>
        
        <!-- –ö–Ω–æ–ø–∫–∞ —Å—Ç–æ–ø (—Å–∫—Ä—ã—Ç–∞) -->
        <button class="btn btn-stop" onclick="stopCamera()" id="btnStop">
            ‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
        </button>

        <!-- –ö–Ω–æ–ø–∫–∞ 2: –§–∞–π–ª/–ù–∞—Ç–∏–≤–Ω–æ–µ —Ñ–æ—Ç–æ -->
        <button class="btn btn-outline" onclick="document.getElementById('fileInput').click()">
            <span>üñºÔ∏è</span> –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ / –°–Ω—è—Ç—å
        </button>
        
        <!-- –°–∫—Ä—ã—Ç—ã–π –∏–Ω–ø—É—Ç –¥–ª—è —Ñ–∞–π–ª–∞ -->
        <input type="file" id="fileInput" accept="image/*" onchange="handleFile(this)">
    </div>

    <div class="loader" id="loader">–ó–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É... ‚è≥</div>

    <!-- –ë–ª–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ -->
    <div id="result" class="result-card"></div>
    
    <!-- –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞) -->
    <button class="btn btn-primary" id="resetBtn" style="display:none; margin-top:15px;" onclick="resetAll()">
        üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥—Ä—É–≥—É—é
    </button>
</div>

<script>
    let html5QrCode;
    const readerElement = document.getElementById('reader');
    const resultElement = document.getElementById('result');
    const loader = document.getElementById('loader');
    
    // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫–∞–Ω–µ—Ä–æ–º ---

    async function startCamera() {
        if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
            alert("–í–Ω–∏–º–∞–Ω–∏–µ! –ö–∞–º–µ—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ HTTPS. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∫–Ω–æ–ø–∫—É '–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ' –∏–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç —á–µ—Ä–µ–∑ –∑–∞—â–∏—â–µ–Ω–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.");
        }

        // –°–±—Ä–æ—Å UI
        resultElement.style.display = 'none';
        document.getElementById('resetBtn').style.display = 'none';
        
        try {
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("reader");
            }
            
            readerElement.style.display = 'block';
            document.getElementById('btnStart').style.display = 'none';
            document.getElementById('btnStop').style.display = 'flex';

            await html5QrCode.start(
                { facingMode: "environment" }, // –ó–∞–¥–Ω—è—è –∫–∞–º–µ—Ä–∞
                { fps: 10, qrbox: { width: 250, height: 250 } },
                (decodedText) => {
                    // –£—Å–ø–µ—à–Ω—ã–π —Å–∫–∞–Ω
                    stopCamera();
                    processCode(decodedText);
                },
                (errorMessage) => {
                    // –û—à–∏–±–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞–¥—Ä–æ–≤ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
                }
            );
        } catch (err) {
            console.error(err);
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∫–Ω–æ–ø–∫—É '–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ'.\n–û—à–∏–±–∫–∞: " + err);
            stopCamera();
        }
    }

    async function stopCamera() {
        if (html5QrCode && html5QrCode.isScanning) {
            await html5QrCode.stop();
        }
        readerElement.style.display = 'none';
        document.getElementById('btnStart').style.display = 'flex';
        document.getElementById('btnStop').style.display = 'none';
    }

    // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞ (—Ñ–æ–ª–ª–±—ç–∫) ---
    
    async function handleFile(input) {
        if (input.files.length === 0) return;
        
        const file = input.files[0];
        
        if (!html5QrCode) {
            html5QrCode = new Html5Qrcode("reader");
        }

        loader.style.display = 'block';
        resultElement.style.display = 'none';

        try {
            const decodedText = await html5QrCode.scanFile(file, true);
            processCode(decodedText);
        } catch (err) {
            loader.style.display = 'none';
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ QR-–∫–æ–¥ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ —á–µ—Ç—á–µ –∏ –±–ª–∏–∂–µ.");
        }
        
        input.value = '';
    }

    // --- –õ–æ–≥–∏–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ ---

    function resetAll() {
        resultElement.style.display = 'none';
        document.getElementById('resetBtn').style.display = 'none';
    }

    function processCode(text) {
        console.log("Code:", text);
        const uid = extractUID(text);
        
        if (uid) {
            fetchSparesInfo(uid);
        } else {
            loader.style.display = 'none';
            alert("QR-–∫–æ–¥ —Å—á–∏—Ç–∞–Ω, –Ω–æ UID –Ω–µ –Ω–∞–π–¥–µ–Ω. –≠—Ç–æ —Ç–æ—á–Ω–æ –∫–æ–¥ –∑–∞–ø—á–∞—Å—Ç–∏?");
        }
    }

    function extractUID(text) {
        try {
            const urlObj = new URL(text);
            const uid = urlObj.searchParams.get("UID") || urlObj.searchParams.get("uid");
            if (uid) return uid;
        } catch (e) {}
        const match = text.match(/[?&]UID=([^&]+)/i);
        if (match) return match[1];
        if (text.length > 10 && !text.includes(' ') && !text.includes('http')) return text;
        return null;
    }

    async function fetchSparesInfo(uid) {
        const brand = document.querySelector('input[name="brand"]:checked').value;
        loader.style.display = 'block';

        // URL API
        const baseUrl = "https://fangwei.geely.com/geelyServiceNew/domain/v1/wx/verify/spares";
        let targetUrl = `${baseUrl}?code=${uid}&t=${Date.now()}`;
        if (brand !== 'GEELY') targetUrl += `&brandCode=${brand}`;

        try {
            const response = await fetch(targetUrl, {
                method: 'GET',
                headers: { 'Accept': 'application/json, text/plain, */*' }
            });

            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            
            loader.style.display = 'none';
            showResult(data, brand);
            document.getElementById('resetBtn').style.display = 'flex';

        } catch (error) {
            console.error(error);
            loader.style.display = 'none';
            showError("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏", error.message);
            document.getElementById('resetBtn').style.display = 'flex';
        }
    }

    function showResult(data, brand) {
        resultElement.className = 'result-card';
        
        if (data && data.UID) {
            // SUCCESS
            resultElement.classList.add('success');
            const titles = {
                'GEELY': 'Geely –û—Ä–∏–≥–∏–Ω–∞–ª',
                'ZEEKR': 'Zeekr –û—Ä–∏–≥–∏–Ω–∞–ª',
                'LYNKCO': 'Lynk&Co –û—Ä–∏–≥–∏–Ω–∞–ª',
                'LINING': 'Lining –û—Ä–∏–≥–∏–Ω–∞–ª'
            };

            resultElement.innerHTML = `
                <h2 style="margin:0 0 15px 0; text-align: center;">‚úÖ ${titles[brand]}</h2>
                <div class="result-row">
                    <span class="label">UID –≤ QR-–∫–æ–¥–µ –∑–∞–ø—á–∞—Å—Ç–∏</span>
                    <span class="value">${data.UID}</span>
                </div>
                <div class="result-row">
                    <span class="label">–ü–∞—Ä—Ç–Ω–æ–º–µ—Ä</span>
                    <span class="value">${data.code || '‚Äî'}</span>
                </div>
                <div class="result-row">
                    <span class="label">–ö–∏—Ç–∞–π—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</span>
                    <span class="value">${data.name || '‚Äî'}</span>
                </div>
                <div class="result-row">
                    <span class="label">–ê–Ω–≥–ª–∏–π—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</span>
                    <span class="value">${data.nameEn || '‚Äî'}</span>
                </div>
                <div class="result-row" style="flex-direction:column; gap:5px;">
                    <span class="label">–ü—Ä–æ–∑–≤–æ–¥–∏—Ç–µ–ª—å</span>
                    <span class="value" style="text-align:left; font-size:14px;">${data.dealerName || '‚Äî'}</span>
                </div>
                <p style="text-align: center; font-size:14px;">–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–ø—á–∞—Å—Ç–∏ –≤—ã—à–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–º, —á—Ç–æ –≤—ã —Ä–µ–∞–ª—å–Ω–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–ª–∏.</p>
            `;
        } else {
            // FAIL
            resultElement.classList.add('error');
            resultElement.innerHTML = `
                <h2 style="margin-top:0; text-align: center;">‚ùå –í–Ω–∏–º–∞–Ω–∏–µ!</h2>
                <p style="text-align: center; font-size:18px;">–î–∞–Ω–Ω—ã–µ –æ –∑–∞–ø—á–∞—Å—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>
                <p style="text-align: center; color: #555; font-size: 14px;">–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:</p>
                <ul style="font-size: 14px; color: #555;">
                    <li>–≠—Ç–æ –ø–æ–¥–¥–µ–ª–∫–∞.</li>
                    <li>–í—ã–±—Ä–∞–Ω –Ω–µ–≤–µ—Ä–Ω—ã–π –±—Ä–µ–Ω–¥ (–ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ Zeekr/Lynk).</li>
                    <li>–û—à–∏–±–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ Geely.</li>
                </ul>
            `;
        }
        resultElement.style.display = 'block';
    }

    function showError(title, msg) {
        resultElement.className = 'result-card error';
        resultElement.innerHTML = `<h3>${title}</h3><p>${msg}</p>`;
        resultElement.style.display = 'block';
    }
</script>

</body>
</html>