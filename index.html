<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∫–∞–Ω–µ—Ä –∞–≤—Ç–æ–∑–∞–ø—á–∞—Å—Ç–µ–π –∫–æ–Ω—Ü–µ—Ä–Ω–∞ Geely</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        :root {
            --primary: #0056b3;
            --bg: #f0f2f5;
            --card: #ffffff;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 600px;
            background: var(--card);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        h1 { margin: 0 0 20px 0; text-align: center; color: #333; font-size: 1.4rem; }

        /* Brand Selector */
        .brand-selector {
            display: flex;
            border: 1px solid var(--primary);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
            flex-shrink: 0;
        }
        .brand-option { flex: 1; position: relative; }
        .brand-option input { position: absolute; opacity: 0; }
        .brand-option label {
            display: block;
            padding: 12px 0;
            text-align: center;
            background: #fff;
            color: var(--primary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border-right: 1px solid var(--primary);
            transition: 0.2s;
        }
        .brand-option:last-child label { border-right: none; }
        .brand-option input:checked + label {
            background: var(--primary);
            color: white;
        }

        /* Video Area (Nimiq Scanner) */
        .scanner-wrapper {
            position: relative;
            width: 100%;
            height: 350px;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            display: none;
        }
        .scanner-wrapper video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .scan-overlay {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 200px; height: 200px;
            border: 2px solid rgba(255, 255, 255, 0.6);
            border-radius: 10px;
            box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5);
            pointer-events: none;
        }

        /* Controls */
        .controls { display: flex; flex-direction: column; gap: 10px; }
        
        .btn {
            border: none;
            padding: 14px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: 0.1s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: white; border: 2px solid var(--primary); color: var(--primary); }
        .btn-stop { background: #dc3545; color: white; display: none; }
        
        .btn-flash { 
            position: absolute; bottom: 20px; right: 20px; 
            background: rgba(255,255,255,0.3); 
            border: 1px solid rgba(255,255,255,0.5);
            color: white; border-radius: 50%; 
            width: 50px; height: 50px; font-size: 24px;
            z-index: 10; display: none;
        }

        /* Results */
        .result-card {
            margin-top: 20px;
            padding: 20px;
            border-radius: 12px;
            display: none;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        .row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .row:last-child { border-bottom: none; }
        .lbl { font-weight: bold; opacity: 0.7; font-size: 0.9rem; }
        .val { font-weight: 500; text-align: right; }

        .loader {
            display: none;
            text-align: center;
            color: var(--primary);
            margin: 20px 0;
            font-weight: bold;
        }
        
        #html5-qr-reader { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>–°–∫–∞–Ω–µ—Ä –∞–≤—Ç–æ–∑–∞–ø—á–∞—Å—Ç–µ–π –∫–æ–Ω—Ü–µ—Ä–Ω–∞ Geely</h1>

    <div class="brand-selector">
        <div class="brand-option"><input type="radio" name="brand" id="b_geely" value="GEELY" checked><label for="b_geely">Geely</label></div>
        <div class="brand-option"><input type="radio" name="brand" id="b_zeekr" value="ZEEKR"><label for="b_zeekr">Zeekr</label></div>
        <div class="brand-option"><input type="radio" name="brand" id="b_lynk" value="LYNKCO"><label for="b_lynk">Lynk</label></div>
        <div class="brand-option"><input type="radio" name="brand" id="b_lining" value="LINING"><label for="b_lining">Lining</label></div>
    </div>

    <!-- –û–±–ª–∞—Å—Ç—å –∫–∞–º–µ—Ä—ã (–¥–ª—è Nimiq Scanner) -->
    <div class="scanner-wrapper" id="scannerWrapper">
        <video id="qr-video"></video>
        <div class="scan-overlay"></div>
        <button class="btn btn-flash" id="flashBtn" onclick="toggleFlash()">üî¶</button>
    </div>

    <div id="html5-qr-reader"></div>

    <div class="controls">
        <button class="btn btn-primary" id="btnStart" onclick="startCamera()">–í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
        <button class="btn btn-stop" id="btnStop" onclick="stopCamera()">–í—ã–∫–ª—é—á–∏—Ç—å</button>

        <button class="btn btn-outline" onclick="document.getElementById('fileInput').click()">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</button>
        <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="scanFromFile(this)">
        
        <button class="btn btn-primary" id="btnReset" style="display:none" onclick="window.location.reload()">üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥—Ä—É–≥—É—é</button>
    </div>

    <div class="loader" id="loader">–ò–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞...</div>
    <div id="result" class="result-card"></div>
</div>

<script type="module">
    import QrScanner from 'https://unpkg.com/qr-scanner@1.4.2/qr-scanner.min.js';
    QrScanner.WORKER_PATH = 'https://unpkg.com/qr-scanner@1.4.2/qr-scanner-worker.min.js';

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let nimiqScanner = null; // –î–ª—è –∫–∞–º–µ—Ä—ã
    let html5FileScanner = null; // –î–ª—è —Ñ–∞–π–ª–æ–≤
    
    const videoElem = document.getElementById('qr-video');
    const wrapper = document.getElementById('scannerWrapper');
    const resultElem = document.getElementById('result');
    const loader = document.getElementById('loader');
    const flashBtn = document.getElementById('flashBtn');

    // === –õ–û–ì–ò–ö–ê –ö–ê–ú–ï–†–´ (Nimiq) ===
    window.startCamera = async () => {
        // UI
        resultElem.style.display = 'none';
        document.getElementById('btnReset').style.display = 'none';
        document.getElementById('btnStart').style.display = 'none';
        wrapper.style.display = 'block';
        document.getElementById('btnStop').style.display = 'flex';

        if (!nimiqScanner) {
            nimiqScanner = new QrScanner(
                videoElem,
                (result) => handleScanSuccess(result.data || result),
                { highlightScanRegion: true, maxScansPerSecond: 5, preferredCamera: 'environment' }
            );
        }

        try {
            await nimiqScanner.start();
            if (await nimiqScanner.hasFlash()) flashBtn.style.display = 'flex';
        } catch (e) {
            console.error(e);
            alert("–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: " + e);
            stopCamera();
        }
    };

    window.stopCamera = () => {
        if (nimiqScanner) {
            nimiqScanner.stop();
            flashBtn.style.display = 'none';
        }
        wrapper.style.display = 'none';
        document.getElementById('btnStop').style.display = 'none';
        document.getElementById('btnStart').style.display = 'flex';
    };

    window.toggleFlash = () => {
        if(nimiqScanner) {
            nimiqScanner.toggleFlash();
            flashBtn.classList.toggle('active');
        }
    };

    // === –õ–û–ì–ò–ö–ê –§–ê–ô–õ–ê (Html5Qrcode) ===
    window.scanFromFile = async (input) => {
        if (!input.files.length) return;
        const file = input.files[0];
        
        stopCamera();
        
        loader.style.display = 'block';
        resultElem.style.display = 'none';

        try {
            if (!html5FileScanner) {
                html5FileScanner = new Html5Qrcode("html5-qr-reader", false);
            }

            const decodedText = await html5FileScanner.scanFile(file, true);
            handleScanSuccess(decodedText);
            
        } catch (err) {
            loader.style.display = 'none';
            console.error(err);
            alert("QR-–∫–æ–¥ –Ω–∞ —Ñ–æ—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±—Ä–µ–∑–∞—Ç—å —Ñ–æ—Ç–æ –∏–ª–∏ —Å–¥–µ–ª–∞—Ç—å –µ–≥–æ —á–µ—Ç—á–µ.");
        }
        input.value = ''; // –°–±—Ä–æ—Å –∏–Ω–ø—É—Ç–∞
    };

    // === –û–ë–©–ê–Ø –õ–û–ì–ò–ö–ê ===
    
    window.resetUI = () => {
        resultElem.style.display = 'none';
        document.getElementById('btnReset').style.display = 'none';
        if(!/Mobi|Android/i.test(navigator.userAgent)) window.startCamera();
    };

    function handleScanSuccess(text) {
        console.log("Decoded:", text);
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
        stopCamera();
        
        const uid = extractUID(text);
        if (uid) {
            fetchData(uid);
        } else {
            loader.style.display = 'none';
            alert("QR –Ω–∞–π–¥–µ–Ω, –Ω–æ UID –∑–∞–ø—á–∞—Å—Ç–∏ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω. –í–µ—Ä–æ—è—Ç–Ω–æ, —ç—Ç–æ –Ω–µ–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –∑–∞–ø—á–∞—Å—Ç—å –∏–ª–∏ –æ–Ω–∞ –Ω–µ –ø–æ–¥–ª–µ–∂–∏—Ç –≤–Ω–µ—Å–µ–Ω–∏—é –≤ –±–∞–∑—É –∑–∞–ø—á–∞—Å—Ç–µ–π.");
        }
    }

    function extractUID(text) {
        try {
            const url = new URL(text);
            const uid = url.searchParams.get("UID") || url.searchParams.get("uid");
            if (uid) return uid;
        } catch (e) {}
        const m = text.match(/[?&]UID=([^&]+)/i);
        if (m) return m[1];
        if (text.length > 10 && !text.includes(' ') && !text.includes('http')) return text;
        return null;
    }

    async function fetchData(uid) {
        const brand = document.querySelector('input[name="brand"]:checked').value;
        loader.style.display = 'block';
        document.querySelector('.controls').style.display = 'none';

        const baseUrl = "https://fangwei.geely.com/geelyServiceNew/domain/v1/wx/verify/spares";
        let url = `${baseUrl}?code=${uid}&t=${Date.now()}`;
        if (brand !== 'GEELY') url += `&brandCode=${brand}`;

        try {
            const res = await fetch(url, { headers: { 'Accept': 'application/json, text/plain, */*' } });
            const data = await res.json();
            renderResult(data, brand);
        } catch (e) {
            showError("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏", e.message);
        } finally {
            loader.style.display = 'none';
            document.querySelector('.controls').style.display = 'flex';
            document.getElementById('btnStart').style.display = 'none';
            document.getElementById('btnReset').style.display = 'flex';
        }
    }

    function renderResult(data, brand) {
        resultElem.className = 'result-card';
        if (data && data.UID) {
            resultElem.classList.add('success');
            resultElem.innerHTML = `
                <h2 style="margin:0 0 15px 0; text-align:center">‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–∞–π–¥–µ–Ω–∞</h2>
                <div class="row"><span class="lbl">UID –∫–æ—Ä–æ–±–∫–∏</span><span class="val">${data.UID}</span></div>
                <div class="row"><span class="lbl">–ü–∞—Ä—Ç–Ω–æ–º–µ—Ä</span><span class="val">${data.code||'-'}</span></div>
                <div class="row"><span class="lbl">–ö–∏—Ç–∞–π—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</span><span class="val">${data.name||'-'}</span></div>
                <div class="row"><span class="lbl">–ê–Ω–≥–ª–∏–π—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</span><span class="val">${data.nameEn||'-'}</span></div>
                <div class="row" style="flex-direction:column"><span class="lbl">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å</span><span class="val" style="text-align:left; font-size:13px; margin-top:4px">${data.dealerName||'-'}</span></div>
                <p style="text-align: center; font-size:14px;">–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–ø—á–∞—Å—Ç–∏ –≤—ã—à–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–º, —á—Ç–æ –≤—ã —Ä–µ–∞–ª—å–Ω–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–ª–∏.</p>
            `;
        } else {
            resultElem.classList.add('error');
            resultElem.innerHTML = `
                <h2 style="margin:0; text-align:center">‚ùå –ü–æ–¥–¥–µ–ª–∫–∞ / –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –±–∞–∑–µ</h2>
                <p style="text-align:center; font-size:14px; margin-top:10px">–°–µ—Ä–≤–µ—Ä –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª —ç—Ç–æ—Ç –∫–æ–¥ –¥–ª—è –±—Ä–µ–Ω–¥–∞ ${brand}.</p>
                <p style="text-align: center; color: #555; font-size: 14px;">–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:</p>
                <ul style="font-size: 14px; color: #555;">
                    <li>- —ç—Ç–æ –ø–æ–¥–¥–µ–ª–∫–∞</li>
                    <li>- –∑–∞–ø—á–∞—Å—Ç—å –Ω–µ –ø–æ–¥–ª–µ–∂–∏—Ç –º–∞—Ä–∫–∏—Ä–æ–≤–∫–µ/–≤–Ω–µ—Å–µ–Ω–∏—é –≤ –ë–î</li>
                    <li>- –≤—ã–±—Ä–∞–Ω –Ω–µ–≤–µ—Ä–Ω—ã–π –±—Ä–µ–Ω–¥ (–ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ Zeekr/Lynk)</li>
                    <li>- –æ—à–∏–±–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ Geely</li>
                </ul>
            `;
        }
        resultElem.style.display = 'block';
    }

    function showError(title, msg) {
        resultElem.className = 'result-card error';
        resultElem.innerHTML = `<h3>${title}</h3><p>${msg}</p>`;
        resultElem.style.display = 'block';
    }
</script>

</body>
</html>
